<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link type="text/css" rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
  <title>Reseptin lisäys</title>
</head>

<body>

  <!-- We will put our React component inside this div. -->
  <div id="root"></div>

  <!-- Load React & Babel -->
  <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Load our React component. -->
  <script type="text/babel">

    function HandleNewFood() {
      const [categories, setCategories] = React.useState([])
      const [units, setUnits] = React.useState([])
      const [food, setFood] = React.useState({
        name: "",
        instructions: "",
        category: "",
        source: "",
        ingredients: [{
          ingredient: "",
          amount: "",
          unit: ""
        }]
      });

      const [inputFields, setInputFields] = React.useState([
        {
          ingredient: "",
          amount: "",
          unit: ""
        }

      ]);

      const addFields = () => {
        const newField = {
          ingredient: "",
          amount: "",
          unit: ""
        }
        setInputFields([...inputFields, newField])
      }

      const handleChange = (e) => {
        setFood({ ...food, [e.target.name]: e.target.value });
      }

      const handleFormChange = (index, event) => {
        const data = [...inputFields];
        data[index][event.target.name] = event.target.value;
        setFood({ ...food, ingredients: data });
      }

      const submit = (e) => {
        fetch("http://localhost:8080/saverecipe", {
          method: "POST",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(food)
        })

      }


      React.useEffect(() => {
        fetch("http://localhost:8080/units")
          .then(response => {
            if (response.ok)
              return response.json()
            alert("Jokin meni vikaan yksikköjen haussa.")
          })
          .then(data => setUnits(data));
      }, []);

      React.useEffect(() => {
        fetch("http://localhost:8080/categories")
          .then(response => {
            if (response.ok)
              return response.json()
            alert("Jokin meni vikaan kategorien haussa.")
          })
          .then(data => setCategories(data));
      }, []);

      return (
        <div style={{display:'grid', alignItems:'center', justifyContent:'center',}}>
          <h1>Lisää uusi resepti</h1>
          <p>Anna reseptin nimi, ohjeet, sekä lähde jos sellainen on. Pudotusvalikoista saat valittua kategorian sekä yksikön.<br />Ainesosia voit lisätä + painikkeesta. Kun olet valmis, paina lähetä.
			Lähettämisen jälkeen resepti siirtyy ylläpitäjän tarkistettavaksi.</p>
          <form onSubmit={submit} action="http://localhost:8080/">
            <input
              type="text"
              name="name"
              placeholder="Nimi"
              value={food.name}
              onChange={handleChange}
              required="required"
            />
            {' '}Kategoria: <select
              name="category"
              value={food.category}
              onChange={handleChange}>
              {Object.keys(categories).map((key, indexForCategories) =>
                <option
                  key={indexForCategories}
                  value={categories[key].name}
                >{categories[key].name}</option>)}
            </select >
            <br></br>
            <textarea
              rows="8"
              cols="50"
              type="text"
              name="instructions"
              maxLength="2000"
              placeholder="Ohjeet. Max 2000 merkkiä."
              value={food.instructions}
              onChange={handleChange}
              required="required"
            /> <br></br>  {`Merkkien määrä ohjeissa: ${food.instructions.length} (max 2000)`}
            {inputFields.map((input, index) => {
              return (
                <div key={index}>
                  <input
                    type="text"
                    name="ingredient"
                    placeholder="Ainesosa"
                    value={food.ingredient}
                    onChange={e=>handleFormChange(index, e)}
                  />
                  <input
                    type="text"
                    name="amount"
                    placeholder="Määrä"
                    value={food.amount}
                    onChange={e=>handleFormChange(index, e)}
                  />
                  <select
                    name="unit"
                    onChange={e=>handleFormChange(index, e)}>
                    {Object.keys(units).map((key, indexForUnits) =>
                      <option
                        key={indexForUnits}
                        value={units[key].unit}
                      >{units[key].unit}</option>)}
                  </select >
                </div>
              )
            })}
            <input
              type="text"
              name="source"
              placeholder="Lähde"
              value={food.source}
              onChange={handleChange}
            />
            <br />

            <input type="submit" value="Lähetä" />
          </form >
          <button style={{width:'50%'}} onClick={addFields}>+</button>
        </div >);

    }



    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<HandleNewFood />);





  </script>
</body>

</html>